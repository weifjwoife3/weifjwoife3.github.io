<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<title>打賴鼠</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --mole-size: 200px;   /* 角色大小 */
    --mask-w: 240px;      /* 蓋板寬 */
    --mask-h: 60px;       /* 蓋板高（覆蓋椅背上緣）*/
    --pop-height: 10px;   /* 露出的高度 */
  }
  html,body{margin:0;background:#121212;color:#fff;font-family:system-ui,Arial,sans-serif}
  .wrap{max-width:1600px;margin:18px auto;padding:0 12px;text-align:center}
  h1{margin:4px 0 10px;font-size:24px}
  .hud{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .stat{background:#232323;border-radius:10px;padding:.45rem .8rem}
  .btn{background:#ffcc00;color:#222;border:0;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer}
  .btn:active{transform:translateY(1px)}

  /* 舞台 */
  .stage{
    position:relative;
    margin:0 auto;
    overflow:hidden;
    background:#000 center/100% 100% no-repeat;
    border-radius:14px;
    box-shadow:0 12px 40px rgba(0,0,0,.55);
    user-select:none;
  }
  /* 兩層：地鼠層 / 蓋板層 */
  #holes, #overlays{ position:absolute; inset:0; }
  #holes{ z-index:10; }
  #overlays{ z-index:20; pointer-events:none; }

  /* 洞與地鼠 */
  .hole{
    position:absolute;
    width:var(--mole-size);
    height:var(--mole-size);
    overflow:hidden;              /* 只露出上緣那一條 */
    cursor:pointer;
  }
  .mole{
    position:absolute; left:50%; bottom:calc(-1 * var(--mole-size));
    width:var(--mole-size); transform:translateX(-50%);
    transition:bottom .22s ease-out;
    filter:drop-shadow(0 12px 10px rgba(0,0,0,.45));
    -webkit-user-drag:none; user-select:none;
  }
  .mole.up{ bottom:var(--pop-height); }

  /* 命中抖動 */
  .mole.hit{ animation: smack-shake .22s linear; }
  @keyframes smack-shake{
    0%{ transform:translateX(-50%) translateY(0) rotate(0deg) }
    25%{ transform:translateX(-50%) translateY(-2px) rotate(-6deg) }
    50%{ transform:translateX(-50%) translateY(1px) rotate(5deg) }
    75%{ transform:translateX(-50%) translateY(-1px) rotate(-3deg) }
    100%{ transform:translateX(-50%) translateY(0) rotate(0deg) }
  }

  /* 椅背蓋板（背景對齊法） */
  .mask{
    position:absolute;
    width:var(--mask-w);
    height:var(--mask-h);
    background-image:url('bg_bus.png');
    background-repeat:no-repeat;
    z-index:1;
    border-radius:18px;
  }

  /* 命中特效：衝擊波圓圈 */
  .fx-ring{
    position:absolute;
    width:20px; height:20px;
    border:4px solid rgba(255,255,255,.8);
    border-radius:50%;
    left:50%; top:0; transform:translate(-50%,-40%);
    opacity:0; z-index:30; pointer-events:none;
    animation: ring .35s ease-out forwards;
  }
  @keyframes ring{
    0%{ opacity:.95; transform:translate(-50%,-40%) scale(.3); }
    100%{ opacity:0; transform:translate(-50%,-40%) scale(2.2); }
  }

  /* 命中 +1 浮動文字 */
  .fx-score{
    position:absolute; left:50%; top:-6px;
    transform:translateX(-50%);
    color:#ffeb3b; font-weight:800; text-shadow:0 2px 6px rgba(0,0,0,.6);
    z-index:30; pointer-events:none;
    animation: floatUp .6s ease-out forwards;
  }
  @keyframes floatUp{
    0%{ opacity:0; transform:translate(-50%,0) scale(.9); }
    20%{ opacity:1; }
    100%{ opacity:0; transform:translate(-50%,-28px) scale(1.05); }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>打賴鼠</h1>
  <div class="hud">
    <div class="stat" id="score">分數：0</div>
    <div class="stat" id="time">剩餘：15.0s</div>
    <button class="btn" id="startBtn">開始</button>
    <button class="btn" id="hardBtn">困難</button>
  </div>

  <div id="stage" class="stage">
    <div id="holes"></div>
    <div id="overlays"></div>
  </div>
</div>

<script>
(() => {
  const BG_SRC='bg_bus.png';
  const SPRITE_NORMAL='mole.png';
  const SPRITE_HIT='mole_hit.png'; // ← 被打中的圖片（你上傳的那張）

  // 你的座標（目前 4 個；想要 6 個直接再補兩筆）
  const COORDS=[
    {"id":"r2l","top":347,"left":198},
    {"id":"r2r","top":285,"left":898},
    {"id":"r3l","top":257,"left":595},
    {"id":"r3r","top":349,"left":1164}
  ];

  const stage = document.getElementById('stage');
  const holesLayer = document.getElementById('holes');
  const overlaysLayer = document.getElementById('overlays');
  const scoreEl = document.getElementById('score');
  const timeEl  = document.getElementById('time');
  const startBtn= document.getElementById('startBtn');
  const hardBtn = document.getElementById('hardBtn');

  /* 舞台尺寸 = 背景原圖像素 */
  function setStageSizeFromImage(src){
    return new Promise((resolve,reject)=>{
      const img=new Image();
      img.onload=()=>{
        const w=img.naturalWidth, h=img.naturalHeight;
        stage.style.width=w+'px';
        stage.style.height=h+'px';
        stage.style.backgroundImage=`url("${BG_SRC}")`;
        resolve({w,h});
      };
      img.onerror=reject;
      img.src=src;
    });
  }

  /* 建立洞與對應蓋板（背景對齊） */
  function buildAll(bgW,bgH){
    holesLayer.innerHTML=''; overlaysLayer.innerHTML='';
    const rs = getComputedStyle(document.documentElement);
    const moleSize = parseInt(rs.getPropertyValue('--mole-size'));
    const maskW    = parseInt(rs.getPropertyValue('--mask-w'));
    const maskH    = parseInt(rs.getPropertyValue('--mask-h'));

    COORDS.forEach(c=>{
      // 地鼠
      const hole=document.createElement('div');
      hole.className='hole'; hole.id=c.id;
      hole.style.top=c.top+'px';
      hole.style.left=c.left+'px';

      const mole=document.createElement('img');
      mole.className='mole';
      mole.src=SPRITE_NORMAL;
      mole.alt='';

      hole.appendChild(mole);
      holesLayer.appendChild(hole);

      // 上層椅背蓋板（偽裝貼圖法）
      const mask=document.createElement('div');
      mask.className='mask';
      mask.style.backgroundSize=`${bgW}px ${bgH}px`;
      const absTop  = c.top + (moleSize - maskH);
      const absLeft = c.left + (moleSize/2 - maskW/2);
      mask.style.top  = absTop+'px';
      mask.style.left = absLeft+'px';
      mask.style.backgroundPosition = `-${absLeft}px -${absTop}px`;
      overlaysLayer.appendChild(mask);
    });
  }

  /* 遊戲邏輯 + 命中特效 */
  let lastHole=null, timeUp=true, score=0, totalMs=15000, minUp=500, maxUp=1100, rafId=null;

  function rand(min,max){ return Math.round(Math.random()*(max-min)+min); }
  function pickHole(){
    const arr=[...holesLayer.querySelectorAll('.hole')];
    let h; do{ h=arr[Math.floor(Math.random()*arr.length)]; } while(h===lastHole);
    lastHole=h; return h;
  }

  function spawnFX(hole){
    // 衝擊波
    const ring=document.createElement('div');
    ring.className='fx-ring';
    hole.appendChild(ring);
    // +1
    const s=document.createElement('div');
    s.className='fx-score';
    s.textContent='+1';
    hole.appendChild(s);
    setTimeout(()=>{ ring.remove(); s.remove(); }, 700);
  }

  function peep(){
    const hole=pickHole();
    const mole=hole.querySelector('.mole');
    const upTime=rand(minUp,maxUp);
    let hit=false;

    mole.classList.add('up');

    const hide=()=>{ mole.classList.remove('up'); };

    const t=setTimeout(()=>{ hide(); if(!timeUp) peep(); }, upTime);

    const onHit=()=>{
      if(hit || !mole.classList.contains('up')) return;
      hit=true;
      score++; scoreEl.textContent='分數：'+score;
      mole.classList.add('hit');
      const oldSrc=mole.src;
      mole.src=SPRITE_HIT;           // 換怒臉
      spawnFX(hole);                 // 特效

      setTimeout(()=>{               // 稍後收回與恢復圖片
        mole.classList.remove('hit');
        mole.src=SPRITE_NORMAL;
        hide();
        clearTimeout(t);
        if(!timeUp) peep();
      }, 350);

      mole.removeEventListener('click', onHit);
    };

    mole.addEventListener('click', onHit, { once:false });
  }

  function startGame(){
    score=0; scoreEl.textContent='分數：0';
    timeUp=false;
    const start=performance.now();
    if(rafId) cancelAnimationFrame(rafId);
    const tick=(now)=>{
      const left=Math.max(totalMs-(now-start),0);
      timeEl.textContent='剩餘：'+(left/1000).toFixed(1)+'s';
      if(left<=0){ timeUp=true; return; }
      rafId=requestAnimationFrame(tick);
    };
    rafId=requestAnimationFrame(tick);
    peep();
  }

  startBtn.addEventListener('click',()=>{ totalMs=15000; minUp=500; maxUp=1100; startGame(); });
  hardBtn .addEventListener('click',()=>{ totalMs=20000; minUp=320; maxUp=820;  startGame(); });

  /* 初始化 */
  setStageSizeFromImage(BG_SRC).then(({w,h})=>{
    buildAll(w,h);
  }).catch(()=>{
    const w=1476, h=768; // 後備尺寸
    stage.style.width=w+'px'; stage.style.height=h+'px'; stage.style.backgroundImage=`url("${BG_SRC}")`;
    buildAll(w,h);
  });
})();
</script>
</body>
</html>

